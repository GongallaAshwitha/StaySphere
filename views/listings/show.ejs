<% layout("layouts/boilerplate") %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <!-- LISTING CARD -->
      <div class="card shadow-lg border-0 mb-4">
        <img 
          src="<%= listing.image?.url || '/images/default.jpg' %>" 
          class="card-img-top"
          style="height:400px; object-fit:cover;"
          alt="<%= listing.title || 'Listing Image' %>"
        >
        <div class="card-body">
          <h2 class="card-title"><%= listing.title || "Untitled Listing" %></h2>

          <p class="text-muted">
            üè† Owned by 
            <strong><%= listing.owner?.username || "Ashwitha Reddy" %></strong>
          </p>

          <p>
            <strong>Description:</strong><br>
            <%= listing.description || "No description provided." %>
          </p>

          <p class="fs-5">
            <strong>Price:</strong>
            ‚Çπ<%= listing.price ? listing.price.toLocaleString("en-IN") : "Not specified" %> / night
          </p>

          <p>
            <strong>Location:</strong>
            <%= listing.location || "Unknown" %>, <%= listing.country || "Unknown" %>
          </p>

          <!-- MAP SECTION -->
          <div class="mt-4">
            <h5>View on Map</h5>
            <div id="map" style="height: 400px; width: 100%; border-radius: 10px;"></div>
          </div>

          <hr>

          <!-- EDIT & DELETE -->
          <% if (currentUser && listing.owner && currentUser._id.equals(listing.owner._id)) { %>
            <div class="d-flex justify-content-between mb-3">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">
                Edit
              </a>
              <form 
                action="/listings/<%= listing._id %>?_method=DELETE"
                method="POST"
                onsubmit="return confirm('Delete this listing?');"
              >
                <button class="btn btn-danger">
                  Delete
                </button>
              </form>
            </div>
          <% } %>

          <div class="text-center mb-4">
            <a href="/listings" class="btn btn-secondary">
              Back to Listings
            </a>
          </div>

        </div>
      </div>

      <!-- REVIEWS SECTION -->
      <div class="mt-5">
        <% let reviews = listing.reviews || []; %>
        <% 
          let totalRating = reviews.reduce((sum, r) => sum + Number(r.rating || 0), 0);
          let avgRating = reviews.length ? (totalRating / reviews.length).toFixed(1) : 0;
        %>

        <div class="d-flex align-items-center mb-3">
          <h4 class="me-3">Reviews</h4>
          <% if (avgRating > 0) { %>
            <div class="d-flex align-items-center">
              <span class="badge bg-warning text-dark me-2 px-2 py-1 rounded">
                <%= avgRating %> / 5
              </span>
              <div>
                <% for(let i = 1; i <= 5; i++) { %>
                  <% if(i <= Math.floor(avgRating)) { %>
                    <i class="bi bi-star-fill text-warning"></i>
                  <% } else if(i - avgRating < 1) { %>
                    <i class="bi bi-star-half text-warning"></i>
                  <% } else { %>
                    <i class="bi bi-star text-warning"></i>
                  <% } %>
                <% } %>
              </div>
              <small class="text-muted ms-2">(<%= reviews.length %>)</small>
            </div>
          <% } else { %>
            <span class="text-muted">No reviews yet</span>
          <% } %>
        </div>

        <!-- REVIEW FORM -->
        <% if (currentUser) { %>
          <div class="card mb-4 shadow-sm">
            <div class="card-body">
              <form action="/listings/<%= listing._id %>/reviews" method="POST">
                <div class="mb-3">
                  <label class="form-label">Comment</label>
                  <textarea 
                    class="form-control"
                    name="review[comment]"
                    rows="3"
                    required
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label class="form-label">Rating</label>
                  <div class="star-rating">
                    <% for(let i = 5; i >= 1; i--) { %>
                      <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" required />
                      <label for="star<%= i %>"><i class="bi bi-star-fill"></i></label>
                    <% } %>
                  </div>
                </div>

                <button class="btn btn-primary w-100">Submit Review</button>
              </form>
            </div>
          </div>
        <% } else { %>
          <p>Please <a href="/login">login</a> to write a review.</p>
        <% } %>

        <hr>

        <!-- REVIEW LIST -->
        <% if (reviews.length === 0) { %>
          <p class="text-muted">No reviews yet. Be the first to review this listing!</p>
        <% } else { %>
          <% reviews.slice().reverse().forEach(review => { %>
            <div class="card mb-3 shadow-sm">
              <div class="card-body d-flex justify-content-between">
                <div>
                  <p><strong>Comment:</strong> <%= review.comment %></p>
                  <div class="mb-1">
                    <% for(let i = 1; i <= 5; i++){ %>
                      <% if(i <= review.rating) { %>
                        <i class="bi bi-star-fill text-warning"></i>
                      <% } else { %>
                        <i class="bi bi-star text-muted"></i>
                      <% } %>
                    <% } %>
                  </div>
                  <small class="text-muted">
                    by <%= review.author?.username || "Unknown" %> on 
                    <%= new Date(review.createdAt).toLocaleDateString() %>
                  </small>
                </div>

                <% if (currentUser && review.author && currentUser._id.equals(review.author._id)) { %>
                  <form 
                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                    method="POST"
                    onsubmit="return confirm('Delete this review?');"
                  >
                    <button class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                <% } %>
              </div>
            </div>
          <% }) %>
        <% } %>

      </div>

    </div>
  </div>
</div>

<!-- Bootstrap Icons -->
<link 
  rel="stylesheet" 
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
/>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const locationQuery = "<%= listing.location || '' %>, <%= listing.country || '' %>";

  if(locationQuery.trim()) {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationQuery)}`)
      .then(res => res.json())
      .then(data => {
        if (data && data.length > 0) {
          const lat = data[0].lat;
          const lon = data[0].lon;

          const map = L.map('map').setView([lat, lon], 13);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);

          const popupContent = `
            <div style="width:200px;">
              <img 
                src="<%= listing.image?.url || '/images/default.jpg' %>" 
                style="width:100%; height:120px; object-fit:cover; border-radius:8px;"
              />
              <h6 style="margin-top:8px; margin-bottom:4px;">
                <%= listing.title || "Untitled Listing" %>
              </h6>
              <p style="margin:0; font-size:14px;">
                ‚Çπ<%= listing.price ? listing.price.toLocaleString("en-IN") : "N/A" %> / night
              </p>
              <small class="text-muted">
                <%= listing.location || "Unknown" %>, <%= listing.country || "Unknown" %>
              </small>
              <br/>
              <a 
                href="/listings/<%= listing._id %>" 
                class="btn btn-sm btn-primary mt-2 w-100"
              >
                View Listing
              </a>
            </div>
          `;

          L.marker([lat, lon])
            .addTo(map)
            .bindPopup(popupContent);
        } else {
          document.getElementById("map").innerHTML =
            "<p class='text-danger'>Location not found</p>";
        }
      })
      .catch(() => {
        document.getElementById("map").innerHTML =
          "<p class='text-danger'>Unable to load map</p>";
      });
  } else {
    document.getElementById("map").innerHTML =
      "<p class='text-danger'>No location provided</p>";
  }
</script>

<style>
/* Star Rating */
.star-rating {
  display: flex;
  flex-direction: row-reverse;
  justify-content: flex-start;
  gap: 0.25rem;
}
.star-rating input[type="radio"] {
  display: none;
}
.star-rating label {
  font-size: 1.5rem;
  color: #ccc;
  cursor: pointer;
  transition: color 0.2s;
}
.star-rating input[type="radio"]:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
  color: #ffc107;
}
</style>
